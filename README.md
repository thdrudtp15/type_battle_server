# 📝 타이핑 배틀 서버

WebSocket을 이용한 실시간 타이핑 대결 게임 서버.

---

## 🚀 시작하기

### 설치

```bash
npm install
```

### 개발 서버 실행

```bash
npm run dev
```

서버는 `http://localhost:3001`에서 실행됩니다.

### 빌드 및 프로덕션 실행

```bash
npm run build
npm start
```

### 환경 변수 설정

`.env` 파일을 생성하고 다음 변수를 설정하세요:

```
NODE_ENV=production
CLIENT_URL=https://your-client-url.com
```

---

## ✨ 주요 기능

-   **실시간 매칭 시스템**: 대기 중인 플레이어를 자동으로 1:1 매칭
-   **게임 방 관리**: Map 자료구조를 활용한 효율적인 방 관리
-   **실시간 점수 계산**: 타이핑 로그를 기반으로 점수 및 정확도 계산
-   **게임 타이머 관리**: 카운트다운 및 게임 시간 관리

## 🛠️ 기술 스택

-   Node.js + Express
-   Socket.io (WebSocket 통신)
-   TypeScript

## 📝 구현 기능

### 매칭 시스템

-   **대기열 관리**: `waitingPlayer` 변수로 대기 중인 플레이어 관리
-   **자동 매칭**: 두 번째 플레이어가 접속하면 즉시 매칭 및 방 생성
-   **방 생성**: 고유한 `roomId` 생성 (`room-${Date.now()}`)
-   **소켓 룸 참가**: Socket.io의 `join()` 메서드로 플레이어를 방에 배치

### 게임 로직 관리

-   **게임 시작 카운트다운**: 매칭 완료 후 3초 카운트다운 후 게임 시작
-   **게임 타이머**: 20초 게임 시간 관리 및 남은 시간 브로드캐스트
-   **문장 관리**: 랜덤으로 선택된 문장 세트를 방에 할당
-   **진행 상황 추적**: 각 플레이어의 문장 인덱스, 진행률, 완료 여부 관리

### 점수 및 정확도 계산

-   **점수 계산**: 문장별 정확도를 계산하여 총점 산출
-   **정확도 계산**: 전체 로그를 기반으로 평균 정확도 계산
-   **진행률 계산**: 완료한 문장 수를 기반으로 진행률 계산
-   **완료 시간 기록**: 모든 문장 완료 시 경과 시간 기록

### 실시간 데이터 동기화

-   **플레이어 데이터 스냅샷**: 각 플레이어에게 자신의 관점에서 데이터 전송
-   **상대방 CPM 전송**: 실시간 CPM 값을 상대방에게 브로드캐스트
-   **게임 로그 업데이트**: 타이핑 로그 수신 시 즉시 점수 재계산 및 전송
-   **게임 종료 처리**: 양쪽 플레이어 모두 완료 시 결과 전송 및 방 정리

### 연결 관리

-   **연결 해제 처리**: 플레이어 연결 해제 시 상대방에게 알림 및 방 정리
-   **매칭 취소**: 대기 중인 플레이어의 매칭 취소 처리
-   **방 정리 함수**: `removeRoom` 함수로 모든 인터벌 정리 및 메모리 해제

## 📚 문제 해결

### 메모리 관리

-   **인터벌 정리**: 게임 종료 시 모든 `setInterval` 정리 (`removeRoom` 함수)
-   **방 삭제**: 게임 종료 또는 연결 해제 시 Map에서 방 제거
-   **참조 해제**: 인터벌 변수를 `null`로 설정하여 메모리 누수 방지

### 데이터 동기화

-   **플레이어 참조 문제 해결**: 각 플레이어에게 개별적으로 스냅샷 데이터 전송
-   **데이터 직접 수정**: 플레이어 객체를 직접 수정하여 참조 문제 방지
-   **상대방 관점 데이터**: 각 플레이어에게 자신이 `player`, 상대가 `opponent`로 전송

### 게임 로직

-   **게임 종료 조건**: 시간 초과 또는 양쪽 플레이어 완료 시 게임 종료
-   **완료 시간 기록**: 게임 시작 시간(`matchStartTime`)을 기준으로 완료 시간 계산
-   **진행률 계산**: 현재 문장 인덱스를 기반으로 정확한 진행률 계산

### 에러 처리

-   **방 존재 확인**: 로그 수신 시 방 존재 여부 확인
-   **플레이어 검증**: `getPlayers`, `getRoomPlayer` 함수로 플레이어 검증
-   **널 체크**: 각 단계에서 플레이어 및 방 데이터의 null 체크

### 성능 최적화

-   **Map 자료구조**: O(1) 시간 복잡도로 방 조회 및 관리
-   **조건부 브로드캐스트**: 필요한 경우에만 데이터 전송
-   **인터벌 최적화**: 1초 간격으로 타이머 업데이트하여 서버 부하 최소화
